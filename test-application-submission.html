<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        button {
            background: #0066cc;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
        }
        button:hover {
            background: #0052a3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .config {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏ –Ω–∞ —á–ª–µ–Ω—Å—Ç–≤–æ</h1>

        <div class="config">
            <strong>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase:</strong>
            <div id="config-status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <form id="applicationForm">
            <div class="form-group">
                <label>–¢–∏–ø —á–ª–µ–Ω—Å—Ç–≤–∞:</label>
                <select name="membershipType" required>
                    <option value="individual">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ</option>
                    <option value="corporate">–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–µ</option>
                </select>
            </div>

            <div class="form-group">
                <label>–ò–º—è:</label>
                <input type="text" name="firstName" value="–¢–µ—Å—Ç" required>
            </div>

            <div class="form-group">
                <label>–§–∞–º–∏–ª–∏—è:</label>
                <input type="text" name="lastName" value="–¢–µ—Å—Ç–æ–≤" required>
            </div>

            <div class="form-group">
                <label>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                <input type="text" name="organizationName" value="–û—Å–û–û –¢–µ—Å—Ç">
            </div>

            <div class="form-group">
                <label>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</label>
                <input type="text" name="position" value="–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫" required>
            </div>

            <div class="form-group">
                <label>Email:</label>
                <input type="email" name="email" value="test@example.com" required>
            </div>

            <div class="form-group">
                <label>–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                <input type="tel" name="phone" value="+996 555 123 456" required>
            </div>

            <div class="form-group">
                <label>–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã:</label>
                <textarea name="experience" required>–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –≤ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å—Ñ–µ—Ä–µ –±–æ–ª–µ–µ 5 –ª–µ—Ç.</textarea>
            </div>

            <div class="form-group">
                <label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è:</label>
                <textarea name="motivation" required>–•–æ—á—É —Ä–∞–∑–≤–∏–≤–∞—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞–≤—ã–∫–∏.</textarea>
            </div>

            <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞—è–≤–∫—É</button>
        </form>

        <div id="result" class="result"></div>
    </div>

    <script type="module">
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env —Ñ–∞–π–ª–∞
        async function loadEnv() {
            try {
                const response = await fetch('./kfa-website/.env');
                const text = await response.text();
                const env = {};

                text.split('\n').forEach(line => {
                    const match = line.match(/^([^=]+)=(.*)$/);
                    if (match) {
                        const key = match[1].trim();
                        const value = match[2].trim().replace(/^["']|["']$/g, '');
                        env[key] = value;
                    }
                });

                return env;
            } catch (error) {
                console.error('Failed to load .env:', error);
                return null;
            }
        }

        async function init() {
            const env = await loadEnv();

            if (!env || !env.VITE_SUPABASE_URL || !env.VITE_SUPABASE_ANON_KEY) {
                document.getElementById('config-status').innerHTML = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Supabase';
                return;
            }

            const supabaseUrl = env.VITE_SUPABASE_URL;
            const supabaseKey = env.VITE_SUPABASE_ANON_KEY;

            document.getElementById('config-status').innerHTML = `
                ‚úÖ URL: ${supabaseUrl.substring(0, 30)}...<br>
                ‚úÖ Key: ${supabaseKey.substring(0, 20)}...
            `;

            const { createClient } = supabase;
            const supabaseClient = createClient(supabaseUrl, supabaseKey);

            const form = document.getElementById('applicationForm');
            const resultDiv = document.getElementById('result');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const button = form.querySelector('button');
                button.disabled = true;
                button.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
                resultDiv.style.display = 'none';

                const formData = new FormData(form);
                const data = {
                    membership_type: formData.get('membershipType'),
                    first_name: formData.get('firstName'),
                    last_name: formData.get('lastName'),
                    organization_name: formData.get('organizationName') || null,
                    position: formData.get('position'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    experience: formData.get('experience'),
                    motivation: formData.get('motivation'),
                    status: 'pending'
                };

                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:', data);

                try {
                    const { data: insertedData, error } = await supabaseClient
                        .from('membership_applications')
                        .insert(data)
                        .select()
                        .single();

                    if (error) throw error;

                    resultDiv.className = 'result success';
                    resultDiv.style.display = 'block';
                    resultDiv.innerHTML = `
                        <h3>‚úÖ –ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!</h3>
                        <p><strong>ID:</strong> ${insertedData.id}</p>
                        <p><strong>Email:</strong> ${insertedData.email}</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${insertedData.status}</p>
                        <p><a href="https://kfa-website.vercel.app/dashboard/applications" target="_blank">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ –∞–¥–º–∏–Ω–∫–µ</a></p>
                    `;

                    console.log('–£—Å–ø–µ—Ö:', insertedData);
                } catch (error) {
                    resultDiv.className = 'result error';
                    resultDiv.style.display = 'block';
                    resultDiv.innerHTML = `
                        <h3>‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</h3>
                        <p>${error.message}</p>
                        <pre>${JSON.stringify(error, null, 2)}</pre>
                    `;

                    console.error('–û—à–∏–±–∫–∞:', error);
                } finally {
                    button.disabled = false;
                    button.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞—è–≤–∫—É';
                }
            });
        }

        init();
    </script>
</body>
</html>
