<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Auth + Upload</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            background: #dcfce7;
            border: 1px solid #86efac;
        }
        .error {
            background: #fee2e2;
            border: 1px solid #fca5a5;
        }
        .info {
            background: #dbeafe;
            border: 1px solid #93c5fd;
        }
        .warning {
            background: #fef3c7;
            border: 1px solid #fcd34d;
        }
        input[type="file"] {
            margin: 10px 0;
        }
        .auth-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .logged-in {
            background: #dcfce7;
            color: #166534;
        }
        .logged-out {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Test: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è + –ó–∞–≥—Ä—É–∑–∫–∞</h1>
        <p>–≠—Ç–æ—Ç —Ç–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏ –∑–∞–≥—Ä—É–∑–∫—É –≤ Supabase Storage</p>

        <div id="authStatus" class="auth-status logged-out">
            ‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        </div>

        <div>
            <h3>–®–∞–≥ 1: –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
            <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—Ç –∂–µ email/–ø–∞—Ä–æ–ª—å —á—Ç–æ –∏ –¥–ª—è dashboard</p>
            <input type="email" id="email" placeholder="Email" style="width: 300px; padding: 8px; margin: 5px;">
            <input type="password" id="password" placeholder="Password" style="width: 300px; padding: 8px; margin: 5px;">
            <br>
            <button onclick="signIn()">üîë –í–æ–π—Ç–∏</button>
            <button onclick="signOut()">üö™ –í—ã–π—Ç–∏</button>
        </div>

        <div>
            <h3>–®–∞–≥ 2: –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h3>
            <input type="file" id="fileInput" accept="image/*">
        </div>

        <div>
            <button onclick="testUpload()" id="uploadBtn" disabled>üöÄ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª (–Ω—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)</button>
            <button onclick="testUploadAnon()">üß™ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</button>
            <button onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://eofneihisbhucxcydvac.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVvZm5laWhpc2JodWN4Y3lkdmFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NzI5NjksImV4cCI6MjA3ODQ0ODk2OX0.9jHkxmjfWQRu6DbFOiqaYH9URxKGHiH7q64HVMYt1eo';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        supabase.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                currentUser = session.user;
                updateAuthStatus(true, session.user.email);
            }
        });

        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                currentUser = session.user;
                updateAuthStatus(true, session.user.email);
            } else {
                currentUser = null;
                updateAuthStatus(false);
            }
        });

        function updateAuthStatus(isLoggedIn, email = null) {
            const statusDiv = document.getElementById('authStatus');
            const uploadBtn = document.getElementById('uploadBtn');

            if (isLoggedIn) {
                statusDiv.className = 'auth-status logged-in';
                statusDiv.textContent = `‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: ${email}`;
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üöÄ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª';
            } else {
                statusDiv.className = 'auth-status logged-out';
                statusDiv.textContent = '‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'üöÄ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª (–Ω—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)';
            }
        }

        async function signIn() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                addResult('‚ùå –í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å!', 'error');
                return;
            }

            addResult('üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...', 'info');

            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password,
            });

            if (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                return;
            }

            addResult(`‚úÖ –£—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏ –∫–∞–∫: ${data.user.email}`, 'success');
        }

        async function signOut() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ${error.message}`, 'error');
            } else {
                addResult('‚úÖ –í—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'info');
            }
        }

        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = message;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function testUpload() {
            if (!currentUser) {
                addResult('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É!', 'error');
                return;
            }

            await performUpload('authenticated');
        }

        async function testUploadAnon() {
            addResult('‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –ë–ï–ó –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–¥–æ–ª–∂–Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å)...', 'warning');
            await performUpload('anon');
        }

        async function performUpload(mode) {
            clearResults();

            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                addResult('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!', 'error');
                return;
            }

            addResult(`üîç –†–µ–∂–∏–º: ${mode === 'authenticated' ? '–° –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π' : '–ë–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏'}`, 'info');
            addResult(`üìÑ –§–∞–π–ª: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`, 'info');

            if (mode === 'authenticated' && currentUser) {
                addResult(`üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${currentUser.email}`, 'info');
                addResult(`üé´ User ID: ${currentUser.id}`, 'info');
            }

            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `test-${Date.now()}.${fileExt}`;
                const filePath = `uploads/${fileName}`;

                addResult(`\n‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∂–∞–µ–º –≤: media/${filePath}`, 'info');

                const { data, error } = await supabase.storage
                    .from('media')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) {
                    addResult(`\n‚ùå –û–®–ò–ë–ö–ê:`, 'error');
                    addResult(`–ö–æ–¥: ${error.statusCode}`, 'error');
                    addResult(`–°–æ–æ–±—â–µ–Ω–∏–µ: ${error.message}`, 'error');

                    if (error.message.includes('row-level security')) {
                        addResult(`\nüí° –ü—Ä–æ–±–ª–µ–º–∞ —Å RLS –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏!`, 'error');
                        if (mode === 'anon') {
                            addResult(`–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ - –ø–æ–ª–∏—Ç–∏–∫–∞ —Ç—Ä–µ–±—É–µ—Ç authenticated —Ä–æ–ª—å`, 'warning');
                        } else {
                            addResult(`–°–¢–†–ê–ù–ù–û! –í—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã, –Ω–æ RLS –≤—Å–µ —Ä–∞–≤–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç.`, 'error');
                            addResult(`\n–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:`, 'error');
                            addResult(`1. –ü–æ–ª–∏—Ç–∏–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ 'public' –≤–º–µ—Å—Ç–æ 'authenticated'`, 'error');
                            addResult(`2. Policy expression –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π`, 'error');
                            addResult(`3. –ù—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É —á–µ—Ä–µ–∑ SQL`, 'error');
                        }
                    }
                    return;
                }

                addResult(`\n‚úÖ –£–°–ü–ï–•!`, 'success');
                addResult(`Path: ${data.path}`, 'success');

                const { data: urlData } = supabase.storage
                    .from('media')
                    .getPublicUrl(data.path);

                addResult(`üîó URL: ${urlData.publicUrl}`, 'success');

                // –£–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
                await supabase.storage.from('media').remove([data.path]);
                addResult(`üóëÔ∏è –¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω`, 'success');

                addResult(`\nüéâ –í–°–ï –†–ê–ë–û–¢–ê–ï–¢!`, 'success');

            } catch (err) {
                addResult(`\n‚ùå –û—à–∏–±–∫–∞: ${err.toString()}`, 'error');
            }
        }
    </script>
</body>
</html>
